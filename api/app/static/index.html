<html>
<head>

<title>Trusted Timestamping</title>
<meta name="description" content="RFC 3161 compliant timestamp gateway">
<meta name="author" content="Brain Interfacing Laboratory">
<meta charset="UTF-8">

<!-- external libraries -->
<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- bootstrap -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js" integrity="sha512-ykZ1QQr0Jy/4ZkvKuqWn4iF3lqPZyij9iRv6sGqLRdTPkY69YX6+7wvVGmsdBbiIfN/8OdsI7HABjvEok6ZopQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- font awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- local scripts -->
<script>

    var buttonsEnabled = true;

    const API_URL = "/";
    const API_PATH = "api/v0.0.2/timestamp?h=";

    async function digestData(data)
    {
        const hash = await window.crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hash));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
        return {array: hashArray, string: hashHex};
    }

    async function readFile(file)
    {
        return new Promise((resolve, reject) =>
        {
            const reader = new FileReader();

            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;

            reader.readAsArrayBuffer(file); 
        });
    }

    async function calculateFileHashes(fileList)
    {
        let hashStr = "";
        let fileHashes = [];

        for (let i = 0; i < fileList.length; i++)
        {
            const fileI = fileList[i];
            if (fileI.hasOwnProperty('webkitRelativePath'))
            {
                var fileName = fileI.webkitRelativePath;
            }
            else
            {
                var fileName = fileI.name;
            }

            const fileData   = await readFile(fileI);
            const fileDigest = await digestData(fileData);

            fileHashes.push({'hash' : fileDigest, 'name' : fileName});
        }

        // sort by digest
        fileHashes.sort((a, b) => a.hash.string.localeCompare(b.hash.string));

        // assemble checksum file string
        for (let i = 0; i < fileHashes.length; i++)
        { 
            hashStr += fileHashes[i].hash.string + "  " + fileHashes[i].name + "\n";
        }
      
        const tenc = new TextEncoder();
        const checksumFileHash = await digestData(tenc.encode(hashStr));

        return {hashStr: hashStr, digest: checksumFileHash};
    }


    function hashDirectory(files)
    {
        return calculateFileHashes(Array.from(files));
    }

    function hashFile(files)
    {
        if (files > 1)
        {
            window.alert("Only one file can be selected. If multiple files are to be timestamped, either do one at a time or choose a directory timestamp.");
            return;
        }

        return calculateFileHashes(files);
    }
    
    function sendTextDownload(ev)
    {

        let filename = "timestamps_" + ev.data.choiceName + ".json";
        let text = JSON.stringify(ev.data.timestamps);

        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
    
        element.style.display = 'none';
        document.body.appendChild(element);
    
        element.click();
    
        document.body.removeChild(element);
    }

    function displayTSModal(repAPI, choiceName)
    {
        // new vs existing
        let title = $("#tsDispModalTitle");
        if (repAPI.newTimestamp)
            title.text("New Timestamp Created");
        else if (!repAPI.newTimestamp)
            title.text("Previous Timestamp Found");

        // get mean timestamp time
        let tsTime = new Date(repAPI.verification
            .map(v => v.time)
            .reduce((avg, time) => avg + time/repAPI.verification.length, 0) * 1000
        );

        $("#tsDispModalBody").empty();

        let digest = repAPI.verification[0].hash.digest;

        // details card
        $("<div></div>").addClass("card my-3").attr("id", "tsCardDetails").appendTo("#tsDispModalBody");
        $("<h4></h4>").addClass("card-header").text("Timestamped: " + tsTime.toLocaleString()).appendTo("#tsCardDetails");

        // download button/icon
        let icon_dl = '<i class="fa-solid fa-download"></i>'
        $("<button></button>").addClass("btn btn-lg bg-cardinal").attr('id', 'tsDownloadBtn')
            .text('Download Timestamp')
            .on("click", {"timestamps" : repAPI.timestamps, "choiceName" : choiceName}, sendTextDownload)
            .appendTo("#tsCardDetails");
        $('#tsDownloadBtn').prepend(icon_dl);

        $("<p></p>").addClass("card-text mt-2").text(repAPI.verification[0].hash.algorithm + " Digest: " + digest.slice(0,8) + "..." + digest.slice(-8)).appendTo("#tsCardDetails");

        // verification card
        $("<div></div>").addClass("card my-3").attr("id", "tsCardVerify").appendTo("#tsDispModalBody");
        $("<h5></h5>").addClass("card-header").text("Timestamp Verification").appendTo("#tsCardVerify");
        $("<div></div>").addClass("row mt-3").attr("id", "tsBadges").appendTo("#tsCardVerify");

        // declare badge icons
        let checkGreen = '<i class="fa-solid fa-circle-check" style="color: #009600;"></i>';
        let xRed = '<i class="fa-solid fa-circle-xmark" style="color: #b40000;"></i>';

        // populate TSA server status
        for (let i = 0; i < repAPI.verification.length; i++)
        {
            let vstat = $('<div></div>').addClass("card-text col");

            if (repAPI.verification[i].status == "OK")
                vstat.append(checkGreen);
            else
                vstat.append(xRed);

            vstat.append($("<p></p>").text(repAPI.verification[i].tsa));
            vstat.appendTo("#tsBadges");
        }

        // show modal
        $("#tsDispModal").modal("show");
    }
        
    
    async function timestampFileHandler()
    {
        if (!buttonsEnabled)
            return;
        else
            buttonsEnabled = false;

        const files = this.files;
        if (files.length > 1)
        {
            var hash = await hashDirectory(files);
            var choiceName = files[0].webkitRelativePath.split('/')[0];
        }
        else
        {
            var hash = await hashFile(files);
            var choiceName = files[0].name;
        }

        const response = await fetch(API_URL + API_PATH + hash.digest.string);
        let repAPI = await response.json();
    
        repAPI.timestamps.name = choiceName;
        repAPI.timestamps.hashfile = {};
        repAPI.timestamps.hashfile.filename = choiceName + ".sha256";
        repAPI.timestamps.hashfile.contents = btoa(hash.hashStr);

        displayTSModal(repAPI, choiceName);

        buttonsEnabled = true;
    }

    async function digestHandler()
    {
        if (!buttonsEnabled)
            return;
        else
            buttonsEnabled = false;

        let digest = $("#inputDigest").val();

        if (digest.length != 64 || !/^[a-f0-9]+$/i.test(digest))
        {
            buttonsEnabled = true;
            return;
        }

        const response = await fetch(API_URL + API_PATH + digest);
        let repAPI = await response.json();

        displayTSModal(repAPI, 'digest');

        buttonsEnabled = true;
    }
  
</script>

<style>
    /* CSS */

    .root-container
    {
        display: grid;
        grid-template-columns: 1fr 2fr 2fr 2fr 1fr;
        grid-template-rows: 1fr 2.5fr 2fr 0.5fr;
        gap: 5% 0px;
        grid-auto-flow: row;
        grid-template-areas:
            ". root-header root-header root-header ."
            ". root-content root-content root-content ."
            ". root-content root-content root-content ."
            ". root-footer root-footer root-footer .";
    }

    .root-header { grid-area: root-header; }
    .root-content { grid-area: root-content; }
    .root-footer { grid-area: root-footer; }

    input[type="file"]
    {
        display: none;
    }

    .bg-cardinal
    {
        background-color: #8C1515;
        color: white;
    }
    
    .ts-button
    {
        margin: 1rem;
        padding: 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 1.25em;
    }
    
</style>

</head>

<body>

    <div class="root-container" align="center">

        <div class="root-header">
            <h1>Trusted Timestamping</h1>
        </div>

        <div class="root-content">

            <label for="pickFile" class="ts-button bg-cardinal" id="pickFileLabel">
                <i class="fa-solid fa-2xl fa-stamp fa-rotate-by" style="--fa-rotate-angle: -30deg;"></i>
                <i class="fa-solid fa-2xl fa-file"></i> Timestamp File</label>
            <input id="pickFile" type="file" />

            <label for="pickDir" class="ts-button bg-cardinal" id="pickDirLabel">
                <i class="fa-solid fa-2xl fa-stamp fa-rotate-by" style="--fa-rotate-angle: -30deg;"></i>
                <i class="fa-solid fa-2xl fa-folder"></i> Timestamp Directory</label>
            <input id="pickDir" type="file" webkitdirectory />

            <div class="row">
                <div class="col-9">
                    <input class="form-control" id="inputDigest" placeholder="Enter SHA256 checksum">
                </div>
                <button type="button" class="btn bg-cardinal col-3" id="btnInputDigest">
                    <i class="fa-solid fa-stamp fa-rotate-by" style="--fa-rotate-angle: -30deg;"></i>
                    <i class="fa-solid fa-hashtag"></i> Timestamp Hash</button>
            </div>

        </div>

        <div class="root-footer">
            <p>For more details and source code, see <a href="http://github.com/bil/timestamping">github.com/bil/timestamping</a></p>
        </div>



    <!-- timestamp display modal -->
    <div class="modal" id="tsDispModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h3 class="modal-title" id="tsDispModalTitle"></h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" id="tsDispModalBody"></div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    </div>

</body>

<script>

    $("#pickFile").on("change", timestampFileHandler);
    $("#pickDir").on( "change", timestampFileHandler);
    $("#btnInputDigest").on("click", digestHandler);

</script>

</html>
