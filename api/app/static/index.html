<html>
<head>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<script>

    const API_PATH = "/api/v0.0.2/timestamp?h=";

    // JavaScript

    async function digestData(data)
    {
        const hash = await window.crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hash));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
        return {array: hashArray, string: hashHex};
    }

    async function readFile(file)
    {
        return new Promise((resolve, reject) =>
        {
            const reader = new FileReader();

            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;

            reader.readAsArrayBuffer(file); 
        });
    }

    async function calculateFileHashes(fileList)
    {
        let hashStr = "";
        let fileHashes = [];

        for (let i = 0; i < fileList.length; i++)
        {
            const fileI = fileList[i];
            if (fileI.hasOwnProperty('webkitRelativePath'))
            {
                var fileName = fileI.webkitRelativePath;
            }
            else
            {
                var fileName = fileI.name;
            }

            const fileData   = await readFile(fileI);
            const fileDigest = await digestData(fileData);

            fileHashes.push({'hash' : fileDigest, 'name' : fileName});
        }

        // sort by digest
        fileHashes.sort((a, b) => a.hash.string.localeCompare(b.hash.string));

        // assemble checksum file string
        for (let i = 0; i < fileHashes.length; i++)
        { 
            hashStr += fileHashes[i].hash.string + "  " + fileHashes[i].name + "\n";
        }
      
        const tenc = new TextEncoder();
        const checksumFileHash = await digestData(tenc.encode(hashStr));

        console.log(fileList);
        console.log(hashStr);
        console.log(checksumFileHash);

        return {hashStr: hashStr, digest: checksumFileHash};
    }


    function hashDirectory(files)
    {
        return calculateFileHashes(Array.from(files));
    }

    function hashFile(files)
    {
        if (files > 1)
        {
            window.alert("Only one file can be selected. If multiple files are to be timestamped, either do one at a time or choose a directory timestamp.");
            return;
        }

        return calculateFileHashes(files);
    }
    
    function sendTextDownload(filename, text)
    {
        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
    
        element.style.display = 'none';
        document.body.appendChild(element);
    
        element.click();
    
        document.body.removeChild(element);
    }
    
    async function timestampFileHandler()
    {
        const files = this.files;
        if (files.length > 1)
        {
            const hash = await hashDirectory(files);
            const choiceName = files[0].webkitRelativePath.split('/')[0];
        }
        else
        {
            const hash = await hashFile(files);
            const choiceName = files[0].name;
        }

        return;

        const response = await fetch(API_PATH + hash.digest.string);
        const tsJSON = await response.json();
    
        tsJSON.name = choiceName;
        tsJSON.hashfile.filename = choiceName + ".sha256";
        tsJSON.hashfile.contents = btoa(hash.hashStr);
    
        sendTextDownload("timestamps_" + choiceName + ".json", JSON.stringify(tsJSON));
    }
  
</script>

<style>
    /* CSS */

    input[type="file"]
    {
        display: none;
    }
    
    .colorful-button
    {
        color: white;
        background-color: #8C1515;
        margin: 1rem;
        padding: 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 1.25em;
    }
    
    h1
    {
        font-size: 3em;
    }

</style>

</head>

<body>

    <div align="center">

        <h1>Trusted Timestamping</h1>

        <br><br>

        <label for="pickFile" class="colorful-button"><i class="fa-solid fa-2xl fa-stamp fa-rotate-by" style="--fa-rotate-angle: -30deg;"></i> <i class="fa-solid fa-2xl fa-file"></i> Timestamp File</label>
        <input id="pickFile" type="file" />

        <label for="pickDir" class="colorful-button"><i class="fa-solid fa-2xl fa-stamp fa-rotate-by" style="--fa-rotate-angle: -30deg;"></i> <i class="fa-solid fa-2xl fa-folder"></i> Timestamp Directory</label>
        <input id="pickDir" type="file" webkitdirectory />

        <br><br><br><br>

        <p>For more details and source code, see <a href="http://github.com/bil/timestamping">github.com/bil/timestamping</a></p>

    </div>


</body>

<script>

    const pickFile = document.getElementById("pickFile");
    const pickDir  = document.getElementById("pickDir");

    pickFile.addEventListener("change", timestampFileHandler, false);
    pickDir.addEventListener( "change", timestampFileHandler, false);

</script>

</html>
